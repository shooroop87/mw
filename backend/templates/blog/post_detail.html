{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ post.title }} | MilanWeek{% endblock %}

{% block meta_description %}{{ post.excerpt|truncatewords:25 }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.excerpt|truncatewords:25 }}{% endblock %}
{% block og_image %}{% if post.image %}{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}{% endif %}{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="breadcrumbs panel z-1 py-2 bg-gray-25 dark:bg-gray-100 dark:bg-opacity-5">
    <div class="container max-w-xl">
        <ul class="breadcrumb nav-x justify-center gap-1 fs-7 sm:fs-6 m-0">
            <li><a href="{% url 'core:home' %}">{% trans "Главная" %}</a></li>
            <li><i class="unicon-chevron-right opacity-50"></i></li>
            {% if post.category %}
            <li><a href="{{ post.category.get_absolute_url }}">{{ post.category.name }}</a></li>
            <li><i class="unicon-chevron-right opacity-50"></i></li>
            {% endif %}
            <li><span class="opacity-50">{{ post.title|truncatewords:5 }}</span></li>
        </ul>
    </div>
</div>

<article class="section panel py-4 lg:py-6">
    <div class="container max-w-xl">
        <div class="section-inner panel">
            <div class="row g-4 xl:g-6">
                
                <!-- Основной контент -->
                <div class="col-12 lg:col-8">
                    <div class="panel vstack gap-4">
                        
                        <!-- Заголовок статьи -->
                        <header class="post-header panel vstack gap-2">
                            {% if post.category %}
                            <div class="post-meta fs-7 fw-bold text-uppercase text-primary">
                                <a href="{{ post.category.get_absolute_url }}">{{ post.category.name }}</a>
                            </div>
                            {% endif %}
                            
                            <h1 class="post-title h3 lg:h1 m-0">{{ post.title }}</h1>
                            
                            {% if post.excerpt %}
                            <p class="fs-5 text-gray-500 dark:text-gray-300">{{ post.excerpt }}</p>
                            {% endif %}
                            
                            <div class="post-meta hstack gap-2 fs-6 text-gray-500 dark:text-gray-400">
                                {% if post.author %}
                                <a href="{% url 'blog:author' post.author.id %}" class="hstack gap-1 text-none hover:text-primary">
                                    {% if post.author.avatar %}
                                    <img class="w-32px h-32px rounded-circle" src="{{ post.author.avatar.url }}" alt="{{ post.author.get_full_name }}">
                                    {% else %}
                                    <span class="w-32px h-32px rounded-circle bg-gray-200 dark:bg-gray-700 cstack">
                                        <i class="unicon-user-avatar"></i>
                                    </span>
                                    {% endif %}
                                    <span>{{ post.author.get_full_name|default:post.author.email }}</span>
                                </a>
                                <span>·</span>
                                {% endif %}
                                <span>{{ post.published_at|date:"d M Y" }}</span>
                                <span>·</span>
                                <span>{{ post.reading_time }} {% trans "мин чтения" %}</span>
                            </div>
                        </header>
                        
                        <!-- Изображение -->
                        {% if post.image %}
                        <figure class="post-media panel overflow-hidden ratio ratio-16x9 rounded m-0">
                            <img class="media-cover" src="{{ post.image.url }}" alt="{{ post.title }}">
                        </figure>
                        {% endif %}
<!-- Контент статьи -->
                        <div class="post-content panel fs-6 lg:fs-5">
                            {{ post.content|safe }}
                        </div>
                        
                        <!-- Теги -->
                        {% if post.tags.all %}
                        <div class="post-tags panel hstack gap-1 flex-wrap">
                            <span class="fs-6 fw-medium text-gray-500">{% trans "Теги:" %}</span>
                            {% for tag in post.tags.all %}
                            <a href="{% url 'blog:tag' tag.slug %}" class="btn btn-xs btn-outline-gray-300 dark:btn-outline-gray-600 rounded-pill">
                                {{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Шеринг -->
                        <div class="post-share panel p-3 bg-gray-25 dark:bg-gray-800 rounded">
                            <div class="hstack justify-between items-center flex-wrap gap-2">
                                <span class="fs-6 fw-medium">{% trans "Поделиться:" %}</span>
                                <ul class="nav-x gap-2">
                                    <li>
                                        <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text={{ post.title|urlencode }}" 
                                           target="_blank" 
                                           class="cstack w-36px h-36px rounded-circle bg-white dark:bg-gray-700 hover:bg-primary hover:text-white transition-all duration-150">
                                            <i class="icon icon-1 unicon-logo-telegram"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="https://vk.com/share.php?url={{ request.build_absolute_uri }}&title={{ post.title|urlencode }}" 
                                           target="_blank" 
                                           class="cstack w-36px h-36px rounded-circle bg-white dark:bg-gray-700 hover:bg-primary hover:text-white transition-all duration-150">
                                            <i class="icon icon-1 unicon-logo-vk"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                                           target="_blank" 
                                           class="cstack w-36px h-36px rounded-circle bg-white dark:bg-gray-700 hover:bg-primary hover:text-white transition-all duration-150">
                                            <i class="icon icon-1 unicon-logo-facebook"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title|urlencode }}" 
                                           target="_blank" 
                                           class="cstack w-36px h-36px rounded-circle bg-white dark:bg-gray-700 hover:bg-primary hover:text-white transition-all duration-150">
                                            <i class="icon icon-1 unicon-logo-x-filled"></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Автор -->
                        {% if post.author %}
                        <div class="post-author panel p-4 bg-gray-25 dark:bg-gray-800 rounded">
                            <div class="row g-3 items-center">
                                <div class="col-auto">
                                    {% if post.author.avatar %}
                                    <img class="w-80px h-80px rounded-circle" src="{{ post.author.avatar.url }}" alt="{{ post.author.get_full_name }}">
                                    {% else %}
                                    <span class="w-80px h-80px rounded-circle bg-gray-200 dark:bg-gray-700 cstack">
                                        <i class="unicon-user-avatar icon-3"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <h4 class="h5 m-0">{{ post.author.get_full_name|default:post.author.email }}</h4>
                                    {% if post.author.bio %}
                                    <p class="fs-6 text-gray-500 dark:text-gray-400 mt-1 mb-0">{{ post.author.bio }}</p>
                                    {% endif %}
                                    <a href="{% url 'blog:author' post.author.id %}" class="fs-6 fw-medium text-primary mt-1 d-inline-block">
                                        {% trans "Все статьи автора" %} →
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Похожие статьи -->
                        {% if related_posts %}
                        <div class="related-posts panel vstack gap-3 pt-4 border-top">
                            <h3 class="h5 m-0">{% trans "Похожие статьи" %}</h3>
                            <div class="row g-3">
                                {% for related in related_posts %}
                                <div class="col-12 sm:col-6">
                                    <article class="post type-post panel uc-transition-toggle">
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="post-media panel overflow-hidden ratio ratio-1x1 rounded">
                                                    <div class="featured-image bg-gray-25 dark:bg-gray-800">
                                                        {% if related.image %}
                                                        <img class="media-cover image uc-transition-scale-up uc-transition-opaque" 
                                                             src="{% static 'images/img-fallback.png' %}" 
                                                             data-src="{{ related.image.url }}" 
                                                             alt="{{ related.title }}" 
                                                             data-uc-img="loading: lazy">
                                                        {% else %}
                                                        <img class="media-cover image" src="{% static 'images/img-fallback.png' %}" alt="{{ related.title }}">
                                                        {% endif %}
                                                    </div>
                                                    <a href="{{ related.get_absolute_url }}" class="position-cover"></a>
                                                </div>
                                            </div>
                                            <div class="col-8">
                                                <div class="post-header panel vstack gap-1">
                                                    <h4 class="post-title h6 m-0 text-truncate-2">
                                                        <a class="text-none hover:text-primary duration-150" href="{{ related.get_absolute_url }}">
                                                            {{ related.title }}
                                                        </a>
                                                    </h4>
                                                    <div class="post-meta fs-7 text-gray-500">
                                                        {{ related.published_at|date:"d M Y" }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </article>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Комментарии -->
                        <div id="comments" class="comments-section panel vstack gap-4 pt-4 border-top">
                            <h3 class="h5 m-0">{% trans "Комментарии" %} ({{ post.comments.count }})</h3>
                            
                            <!-- Форма комментария -->
                            {% if user.is_authenticated %}
                            <form class="comment-form panel vstack gap-2" method="post" action="{% url 'blog:add_comment' post.slug %}">
                                {% csrf_token %}
                                <textarea name="content" class="form-control" rows="4" placeholder="{% trans 'Напишите комментарий...' %}" required></textarea>
                                <div class="hstack justify-end">
                                    <button type="submit" class="btn btn-primary">{% trans "Отправить" %}</button>
                                </div>
                            </form>
                            {% else %}
                            <div class="panel p-3 bg-gray-25 dark:bg-gray-800 rounded text-center">
                                <p class="m-0">
                                    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="uc-link">{% trans "Войдите" %}</a>
                                    {% trans ", чтобы оставить комментарий" %}
                                </p>
                            </div>
                            {% endif %}
                            
                            <!-- Список комментариев -->
                            <div class="comments-list panel vstack gap-3">
                                {% for comment in post.comments.all %}
                                <div class="comment panel p-3 bg-gray-25 dark:bg-gray-800 rounded">
                                    <div class="hstack gap-2 mb-2">
                                        {% if comment.author.avatar %}
                                        <img class="w-40px h-40px rounded-circle" src="{{ comment.author.avatar.url }}" alt="{{ comment.author.get_full_name }}">
                                        {% else %}
                                        <span class="w-40px h-40px rounded-circle bg-gray-200 dark:bg-gray-700 cstack">
                                            <i class="unicon-user-avatar"></i>
                                        </span>
                                        {% endif %}
                                        <div>
                                            <h6 class="m-0 fs-6">{{ comment.author.get_full_name|default:comment.author.email }}</h6>
                                            <span class="fs-7 text-gray-500">{{ comment.created_at|date:"d M Y, H:i" }}</span>
                                        </div>
                                    </div>
                                    <p class="m-0 fs-6">{{ comment.content }}</p>
                                </div>
                                {% empty %}
                                <p class="text-gray-500 text-center py-3">{% trans "Пока нет комментариев. Будьте первым!" %}</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Сайдбар -->
                <div class="col-12 lg:col-4">
                    {% include "blog/includes/sidebar.html" %}
                </div>
                
            </div>
        </div>
    </div>
</article>
{% endblock %}